name: Daily Cache Refresh

on:
  schedule:
    # Run at 8:00 UTC daily (midnight Pacific, after NOAA posts data)
    - cron: '0 8 * * *'
  workflow_dispatch:  # Manual trigger button in GitHub UI

jobs:
  refresh-cache:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install system dependencies (eccodes for GRIB)
        run: |
          sudo apt-get update
          sudo apt-get install -y libeccodes-dev libeccodes-tools

      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install -e ".[all]"

      - name: Run cache refresh
        run: |
          python scripts/daily_refresh.py
        env:
          # Herbie cache directory
          HERBIE_HOME: ${{ github.workspace }}/.herbie_cache

      - name: Show cache stats
        run: |
          python -c "
          from snowforecast.cache.database import CacheDatabase, DEFAULT_DB_PATH
          db = CacheDatabase(DEFAULT_DB_PATH)
          stats = db.get_stats()
          print(f'Forecasts: {stats[\"forecast_count\"]}')
          print(f'Terrain: {stats[\"terrain_count\"]}')
          print(f'Latest run: {stats[\"latest_run_time\"]}')
          db.close()
          "

      - name: Commit and push updated cache
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Force add the cache file (it's in .gitignore exception)
          git add -f data/cache/snowforecast.duckdb

          # Only commit if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Daily cache refresh $(date -u +%Y-%m-%d)

            Automated refresh of HRRR/NBM forecasts for all ski areas.

            ðŸ¤– Generated by GitHub Actions"
            git push
          fi
